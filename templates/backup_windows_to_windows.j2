{% set step_counter = 1 %}
{{ step_counter }}. On target Windows server, create SMB share (if not already available) at \\{{ target_host }}\{{ target_share }}

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. On source Windows server, map network drive:
   net use Z: \\{{ target_host }}\{{ target_share }} /user:{{ target_user }} <password>

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. {% if versioning %}Create timestamped folder:
   $timestamp = Get-Date -Format "yyyyMMdd"
   $targetFolder = "Z:\{{ source_host }}\$timestamp"
   New-Item -ItemType Directory -Path $targetFolder
{% else %}Use target folder: Z:\{{ source_host }}
{% endif %}

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Back up source folders to defined backup location
{% for source_path in source_paths %}
{{ step_counter }}.{{ loop.index }} Run Robocopy from {{ source_path }} to target folder:
   robocopy {{ source_path }} {{ "$targetFolder" if versioning else "Z:\\{}".format(source_host) }} /MIR {{ robocopy_options }} /LOG:C:\backup\backup.log
{% endfor %}

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Verify the files on target Windows server.

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Unmap network drive:
   net use Z: /delete

{% if retention_days and versioning %}
    {% set step_counter = step_counter + 1 %}
{{ step_counter }}. Optional: implement retention policy (PowerShell script) to delete folders older than {{ retention_days }} days on Windows target.
{% endif %}