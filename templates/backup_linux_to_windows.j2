{% set step_counter = 1 %}
{{ step_counter }}. On Linux source server, mount Windows SMB share:

   sudo mount -t cifs -o username={{ target_user }},password=<password> //{{ target_host }}/{{ target_share }} /mnt/backup

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. {% if versioning %}Create timestamped target folder on mounted share:
   TIMESTAMP=$(date +"%Y%m%d")
   mkdir -p /mnt/backup/{{ source_host }}/$TIMESTAMP
{% else %}Use target folder on mounted share: /mnt/backup/{{ target_base_name }}
{% endif %}

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Back up source folders to defined backup location
{% for source_path in source_paths %}
{{ step_counter }}.{{ loop.index }}. Run rsync from {{ source_path }} to Windows share:
   rsync {{ rsync_options }} {{ source_path }} /mnt/backup/{{ source_host }}{{ "/$TIMESTAMP" if versioning else "" }}
{% endfor %}

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Verify the files on Windows server.

{% set step_counter = step_counter + 1 %}
{{ step_counter }}. Unmount SMB share:
   sudo umount /mnt/backup

{% if retention_days and versioning %}
    {% set step_counter = step_counter + 1 %}
{{ step_counter }}. Optional: remove old backups older than {{ retention_days }} days (manually or with script on Windows share).
{% endif %}